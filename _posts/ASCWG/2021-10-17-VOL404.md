---
title: "VOL404"
classes: wide
header:  
  teaser: /assets/images/ASCWG/mem.gif
ribbon: green
description: "we need an advanced memory forensics investigator, we were under attack, and tried to take a memory dump from the machine but the APT corrupted the dump then wiped all the data from our system, hopefully, our new software  dumped part of PAGE TABLE ENTRY. we lost our business, the only hope for us is to find this APT G, the only hope is this corrupted memory dump."
categories:
  - CTF Write_up
  - DIGITAL FORENSICS
  - DFIR 
toc: true
---

# About Challenge.

Name  : Vol 404 .

Level : very Hard (3zab).

PTS : 1500

Description : we need an advanced memory forensics investigator, we were under attack, and tried to take a memory dump from the machine but the APT corrupted the dump then wiped all the data from our system, hopefully, our new software  dumped part of PAGE TABLE ENTRY. we lost our business, the only hope for us is to find this APT G, the only hope is this corrupted memory dump. 

Link : [challenge link](https://mega.nz/file/9JkW2KgL#3SHkp4GaOzHsvyxRkvb2QoGka2rA8Xqap9ZpdJbHVDs) 

Files : vol404.tar.gz .

Hash : 8be5f0e0d2f83782277b3df4ef86307e 

# Note

1 - the main reason for this challenge is to publish this write up. 

2 - in a real case of a memory corrupted memory dump, you will need to fix the dump then you can analyse it, if you follow this solution in a real case you will not solve it because the pointers will point to invalid locations but here I edited the memory.

3 - the main technical reason for this challenge is to know how to walk throw a memory without volatility, imagine having a case with a new Windows Kernel version that has new structs (thread, process, file, .., etc), will you wait for a volatility update ?? 

# challenge discovery 
When you extract the tar.gz file you will find 2 files, chall.vmem which is a memory dump, and pagetable.backup which contains part of the page table entry.

Once we have a memory dump we will directly use volatility. 

## vol mission
I'm using volatility 2 so I will start by getting the memory suggested profiles.  

[![1](/assets/images/ASCWG/m1.png)](/assets/images/ASCWG/m1.png)

and it's windows 7 64 bit . 

time to check running processes, using pslist plugin. 

[![2](/assets/images/ASCWG/m2.png)](/assets/images/ASCWG/m2.png)

but , no thing found voltility couldent follow the KDOM double linked list to find the running processes.

The description said that the dump is corrupted, not encrypted, so if we could do a brute force search for the EPROCESS header bytes regardless of the pages we could find the present process on the system. 

so psscan shold give us some output . 

[![3](/assets/images/ASCWG/m3.png)](/assets/images/ASCWG/m3.png)

As expected, psscan did the mission. 

and its clear from the process named **FOLLOWMYHEAP** that the flag is on its heap . 

but where to find the process heap and heaps !

in process **Peb** structure  we can find a pointer to process heap.<sub><sup>[1]</sup></sub>

[![4](/assets/images/ASCWG/m4.png)](/assets/images/ASCWG/m4.png)

and peb is part of **EPROCESS** struct . 

but we can't use volatility shell to work with the internals because the dump is corrupted, the only way for us is to use a hex-editor. 

# Walk throw internals 

we will not start from point 0, because we got important information from psscan which is the physical address of the target process , which is **0xf51fd50** 

you can start by jumping to this location.

now we are standing on the start byte of the target eprocess struct.

the next step we need to know the kenel verion of this mechine , we can do it in 2 wayes .

the first is to search for windows7 kernel verion.<sub><sup>[2]</sup></sub>

[![5](/assets/images/ASCWG/m5.png)](/assets/images/ASCWG/m5.png)

windows 7 version  is 6.1 . 

the second way is to use the process id and search for it in the struct, once you find its location you can search for which version PID will be in this position. 

you will find that pid location is 0x180 , search for pid with location 0x180 in eprocess struct.<sub><sup>[3]</sup></sub>

[![6](/assets/images/ASCWG/m6.png)](/assets/images/ASCWG/m6.png)

# resources 

[1- PEB struct](https://www.nirsoft.net/kernel_struct/vista/PEB.html)

[2- kernel version](https://en.wikipedia.org/wiki/Comparison_of_Microsoft_Windows_versions)

[1- Eprocess struct](https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ps/eprocess/index.htm)
